<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Piccolo OS Plus: Pre-emptive multitasking</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Piccolo OS Plus<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">A feature rich extension of Piccolo OS</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Pre-emptive multitasking </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
What is pre-emptive multitasking?</h1>
<p >In a co-operative multitasking environment it is up to each task to yield control back to the kernel so that another task has the chance to run. In a pre-emptive environment the kernel forces control away from a task and lets another task run.</p>
<p >To do this, Piccolo OS uses the Systick exception. In essence, a Systick exception is raised by the hardware when the Systick counter reaches zero. The Systick Control, Reload, and Status resisters control how long it takes between exceptions, and if the exception is enabled or disabled. The Systick timer uses a 1Î¼s clock.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
How do we avoid breaking the rest of the Pico SDK system?</h1>
<p >Truth be told, we <em>cannot</em> do a perfect job. The Pico SDK documentation specifically states that much of the standard C library is not "core safe". (They mean you cannot call it from multiple cores, but this would also apply to multiple tasks if preemption is allowed.) They do promise that <code>printf()</code> and the <code>malloc(), calloc(), free()</code> family <em>are</em> core safe. They also advise users that the SDK provides mutexes which a user could use to gate library function use.</p>
<p >The Piccolo OS files <code>piccolo_os_lock_core_v1.1.c</code> and <code>piccolo_os_lock_core_v1.1.h</code> integrate Piccolo OS with the SDK internals so that all of the SDK provided interlocking mechanisms such as mutexes and semaphores become <em>task safe</em> as well as core safe.</p>
<ul>
<li>NOTE: While <code>malloc()</code> and <code>free()</code> <em>are</em> task safe and protected from preemption on both cores, they are protected by mutexes and mutexes are <em>not</em> interrupt safe. Since the kernal <em>is</em> an interrupt handler, we cannot call <code>malloc()</code> or <code>free()</code> from within the kernal!</li>
</ul>
<h1><a class="anchor" id="autotoc_md3"></a>
Preempting Interrupt Service Routines</h1>
<p >We should worry about Systick preempting interrupt service handlers and timer routines. The Pico SDK configures all external interrupt priorities to level 2. (The ARM Cortex M0 has four levels, with 0 being highest priority and 3 being lowest.) This means that the default Systick (and SVC) priorities (set to 0) will be higher than any IRQ's used by the SDK or the user. Doing a preemptive context switch during an Interrupt Service Routine would be a <b>disaster</b>! Since the user can also lower IRQ priorities further, we set the IRQ priorities for SVC and Systick to the lowest possible level.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Do we create any race conditions with two exceptions doing the same thing?</h1>
<p >The exception handlers for Systick and SVC both go to the kernal. Does this create a problem? The short answer is yes! The timer can expire just before the SVC, or simultaneously. It can also expire while the scheduler is running (after the SVC)! We did at least make sure that neither exception will preempt the other when we set <em>both</em> their priorities to the lowest level.</p><ul>
<li>If the Systick timer expires before the SVC instruction executes, then the task misses the boat and will skip a turn when it resumes and executes the SVC instruction. (So sad!)</li>
<li>If both the SVC and Systick happen at the same time then SVC wins with a lower exception number and the Systick interrupt will be pending. This is the same as Systick expiring while the scheduler is running because of an SVC, and will be discussed below. (Note that <em>at the same time</em> here means that Systick fires during the execution of the SVC instruction.)</li>
<li>The Systick timer can expire while the scheduler is running due to an SVC instruction. The scheduler is the exception handler and will not be preempted by the Systick interrupt because they are at the same priority level. But the Systick exception will be pending and will happen as soon as the scheduler switches to the next task! We can solve this by making sure that the scheduler specifically disables the Systick timer and then clears any pending Systick exceptions. The timer can then be restarted when the next task is run. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
